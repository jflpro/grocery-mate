<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FrigoBuddy - Gestion du Réfrigérateur</title>
    <!-- Chargement de Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chargement de Vue 3 via CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- FIREBASE IMPORTS (Nécessaires pour l'authentification et Firestore) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables MUST be defined in the window object for Vue to access them easily
        window.firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (Object.keys(window.firebaseConfig).length > 0) {
            window.app = initializeApp(window.firebaseConfig);
            window.db = getFirestore(window.app);
            window.auth = getAuth(window.app);
            setLogLevel('Debug'); // Enable debug logging for Firestore

            // Sign in process
            const signInUser = async () => {
                try {
                    if (window.initialAuthToken) {
                        await signInWithCustomToken(window.auth, window.initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(window.auth);
                        console.log("Signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                }
            };
            
            signInUser();
        } else {
            console.warn("Firebase configuration not found. Running in mock mode.");
        }
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#059669', // Emerald 600
                        'secondary': '#374151', // Gray 700
                        'background-light': '#F9FAFB',
                        'accent': '#F59E0B', // Amber 500
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        .btn-primary {
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        .btn-primary:hover {
            background-color: #047857; /* Darker green */
            transform: translateY(-1px);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150;
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #9CA3AF;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #F3F4F6;
        }
    </style>
</head>
<body class="bg-background-light min-h-screen font-sans antialiased">

<div id="app"></div>

<script type="module">
    const { createApp, ref, reactive, computed, watch, onMounted, nextTick } = Vue;

    // --- 1. Gestion de l'état global (Remplace Pinia) ---
    const store = reactive({
        user: null, // L'objet utilisateur de Firebase
        isAuthReady: false,
        isAuthenticated: computed(() => !!store.user),
        currentPage: 'login', // 'login' | 'register' | 'fridge'
        items: [], // Tableau des articles du frigo
        loading: false,
        error: null,
        userId: computed(() => store.user ? store.user.uid : 'anonymous'),
        
        // Firestore path helpers (using the mandatory global variables)
        getUserCollectionRef() {
            if (!window.db || !store.user) return null;
            return collection(window.db, `artifacts/${window.appId}/users/${store.user.uid}/fridge_items`);
        },
        getPublicCollectionRef() {
            if (!window.db) return null;
            return collection(window.db, `artifacts/${window.appId}/public/data/shared_fridge_items`);
        }
    });

    // --- 2. Fonctions d'authentification (Vue Logic) ---
    const useAuth = () => {
        const email = ref('');
        const password = ref('');
        const authError = ref(null);
        const authLoading = ref(false);

        const handleAuthError = (err) => {
            authLoading.value = false;
            console.error("Auth Error:", err);
            if (err.code) {
                 authError.value = {
                    'auth/email-already-in-use': 'Cette adresse e-mail est déjà utilisée.',
                    'auth/invalid-email': 'Le format de l\'e-mail est invalide.',
                    'auth/operation-not-allowed': 'Opération non autorisée. Contactez l\'administrateur.',
                    'auth/weak-password': 'Le mot de passe doit contenir au moins 6 caractères.',
                    'auth/user-not-found': 'Aucun utilisateur trouvé avec cet e-mail.',
                    'auth/wrong-password': 'Mot de passe incorrect.',
                }[err.code] || 'Une erreur d\'authentification inconnue est survenue.';
            } else {
                authError.value = 'Erreur: ' + err.message;
            }
             setTimeout(() => authError.value = null, 5000);
        };

        const register = async () => {
            if (!window.auth) {
                handleAuthError({ message: "Le service d'authentification n'est pas prêt." });
                return;
            }
            authLoading.value = true;
            authError.value = null;
            try {
                await createUserWithEmailAndPassword(window.auth, email.value, password.value);
                // Le listener onAuthStateChanged gérera la transition vers 'fridge'
            } catch (err) {
                handleAuthError(err);
            }
        };

        const login = async () => {
            if (!window.auth) {
                handleAuthError({ message: "Le service d'authentification n'est pas prêt." });
                return;
            }
            authLoading.value = true;
            authError.value = null;
            try {
                await signInWithEmailAndPassword(window.auth, email.value, password.value);
                // Le listener onAuthStateChanged gérera la transition vers 'fridge'
            } catch (err) {
                handleAuthError(err);
            }
        };
        
        const logout = async () => {
             if (window.auth) {
                await signOut(window.auth);
                store.currentPage = 'login';
                store.items = []; // Clear items on logout
            }
        };

        return { email, password, authError, authLoading, register, login, logout };
    };

    // --- 3. Fonctions Firestore (Vue Logic) ---
    const useFridge = () => {
        const newItemName = ref('');
        const newItemExpiry = ref('');
        const itemLoading = ref(false);
        const itemError = ref(null);

        // Écoute des changements de la base de données en temps réel
        let unsubscribe = null;
        
        watch(() => store.user, (newUser) => {
            // Unsubscribe from previous listener if user changes or logs out
            if (unsubscribe) {
                unsubscribe();
                unsubscribe = null;
            }

            if (newUser && window.db) {
                subscribeToFridgeItems();
            } else {
                store.items = [];
            }
        }, { immediate: true });

        const subscribeToFridgeItems = () => {
            const colRef = store.getUserCollectionRef();
            if (!colRef) return;

            // Utilisation de onSnapshot pour les mises à jour en temps réel
            unsubscribe = onSnapshot(colRef, (snapshot) => {
                const fetchedItems = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    fetchedItems.push({
                        id: doc.id,
                        name: data.name,
                        expiryDate: data.expiryDate,
                        addedAt: data.addedAt ? data.addedAt.toDate() : new Date(),
                    });
                });
                // Tri par date d'expiration
                fetchedItems.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));
                store.items = fetchedItems;
                console.log("Items updated from Firestore. Count:", fetchedItems.length);
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                itemError.value = "Erreur de chargement des données.";
                setTimeout(() => itemError.value = null, 5000);
            });
        };

        const addItem = async () => {
            if (!newItemName.value.trim() || !newItemExpiry.value) return;
            itemLoading.value = true;
            itemError.value = null;

            const colRef = store.getUserCollectionRef();
            if (!colRef) {
                itemError.value = "Authentification requise pour ajouter un article.";
                itemLoading.value = false;
                return;
            }

            try {
                const newItem = {
                    name: newItemName.value.trim(),
                    expiryDate: newItemExpiry.value,
                    addedAt: new Date(),
                    userId: store.userId.value // Store user ID for potential future use
                };

                await addDoc(colRef, newItem);
                
                newItemName.value = '';
                newItemExpiry.value = '';
            } catch (err) {
                console.error("Error adding item:", err);
                itemError.value = "Impossible d'ajouter l'article: " + err.message;
            } finally {
                itemLoading.value = false;
                setTimeout(() => itemError.value = null, 5000);
            }
        };

        const deleteItem = async (id) => {
            itemLoading.value = true;
            itemError.value = null;

            const colRef = store.getUserCollectionRef();
            if (!colRef) {
                itemError.value = "Authentification requise pour supprimer un article.";
                itemLoading.value = false;
                return;
            }

            try {
                // doc(db, collectionPath, docId)
                const docRef = doc(window.db, colRef.path, id); 
                await deleteDoc(docRef);
            } catch (err) {
                console.error("Error deleting item:", err);
                itemError.value = "Impossible de supprimer l'article: " + err.message;
            } finally {
                itemLoading.value = false;
                setTimeout(() => itemError.value = null, 5000);
            }
        };

        // Fonction utilitaire pour le calcul du statut d'expiration
        const getExpiryStatus = (expiryDate) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            const expiry = new Date(expiryDate);
            expiry.setHours(0, 0, 0, 0);

            const diffTime = expiry.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return { text: "Expiré", color: 'bg-red-500', days: diffDays };
            } else if (diffDays === 0) {
                return { text: "Expire aujourd'hui", color: 'bg-yellow-500', days: 0 };
            } else if (diffDays <= 3) {
                return { text: `J-${diffDays}`, color: 'bg-amber-400', days: diffDays };
            } else {
                return { text: `J+${diffDays}`, color: 'bg-primary', days: diffDays };
            }
        };
        
        // Nettoyage lors de la destruction du composant (non pertinent ici mais bonne pratique)
        onMounted(() => {
            return () => {
                if (unsubscribe) unsubscribe();
            };
        });


        return { 
            newItemName, 
            newItemExpiry, 
            itemLoading, 
            itemError, 
            addItem, 
            deleteItem, 
            getExpiryStatus 
        };
    };
    
    // --- 4. Composants Vue ---

    // Composant pour l'écran de connexion et d'inscription
    const AuthScreen = {
        setup() {
            const { email, password, authError, authLoading, register, login } = useAuth();
            const isLogin = computed(() => store.currentPage === 'login');

            return {
                email, password, authError, authLoading, register, login, isLogin, store
            };
        },
        template: `
        <div class="flex flex-col items-center justify-center min-h-screen bg-background-light p-4">
            <div class="w-full max-w-md bg-white p-8 rounded-xl card">
                <h1 class="text-3xl font-bold text-center text-secondary mb-6">
                    {{ isLogin ? 'Connexion' : 'Inscription' }}
                </h1>
                
                <p class="text-sm text-center text-gray-500 mb-6">
                    ID utilisateur (pour partage) : 
                    <span class="font-mono text-xs p-1 bg-gray-100 rounded">{{ store.userId }}</span>
                </p>

                <!-- Affichage des erreurs -->
                <div v-if="authError" class="p-3 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
                    {{ authError }}
                </div>

                <form @submit.prevent="isLogin ? login() : register()" class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">E-mail</label>
                        <input type="email" id="email" v-model="email" required class="input-field" placeholder="votre@email.com">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
                        <input type="password" id="password" v-model="password" required class="input-field" minlength="6" placeholder="******">
                    </div>

                    <button type="submit" :disabled="authLoading" class="btn-primary w-full py-3 mt-4 text-white font-semibold rounded-lg bg-primary hover:bg-emerald-700 flex items-center justify-center">
                        <span v-if="authLoading">Chargement...</span>
                        <span v-else>{{ isLogin ? 'Se connecter' : 'Créer un compte' }}</span>
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <button @click="store.currentPage = isLogin ? 'register' : 'login'" class="text-sm text-primary hover:text-emerald-700 font-medium">
                        {{ isLogin ? 'Pas encore de compte? Inscrivez-vous' : 'Déjà un compte? Connectez-vous' }}
                    </button>
                </div>
            </div>
        </div>
        `
    };

    // Composant principal de gestion du frigo
    const FridgeScreen = {
        components: { ItemCard },
        setup() {
            const { newItemName, newItemExpiry, itemLoading, itemError, addItem, deleteItem, getExpiryStatus } = useFridge();
            const { logout } = useAuth();
            
            // Computed property for filtering and sorting items
            const itemsToDisplay = computed(() => {
                // Items are already sorted by expiry date in the store logic
                return store.items;
            });
            
            // Stats (optional: check items that are expired)
            const expiredCount = computed(() => {
                return store.items.filter(item => getExpiryStatus(item.expiryDate).days < 0).length;
            });

            return {
                store,
                itemsToDisplay,
                newItemName,
                newItemExpiry,
                itemLoading,
                itemError,
                addItem,
                logout,
                deleteItem,
                getExpiryStatus,
                expiredCount
            };
        },
        template: `
        <div class="min-h-screen bg-gray-100 p-4 sm:p-8">
            <header class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-extrabold text-secondary">
                    FrigoBuddy 
                    <span class="text-primary text-sm font-normal">({{ store.items.length }} articles)</span>
                </h1>
                <div class="flex items-center space-x-3">
                    <span class="text-sm text-gray-600 hidden sm:inline">Connecté: {{ store.user?.email || 'Anonyme' }}</span>
                    <button @click="logout" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition duration-150 shadow-md">
                        Déconnexion
                    </button>
                </div>
            </header>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Colonne 1: Ajout d'article -->
                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-xl card sticky top-4">
                        <h2 class="text-xl font-bold text-secondary mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Ajouter un Article
                        </h2>
                        
                        <div v-if="itemError" class="p-3 mb-4 text-sm text-red-700 bg-red-100 rounded-lg">{{ itemError }}</div>

                        <form @submit.prevent="addItem" class="space-y-4">
                            <div>
                                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Nom de l'article</label>
                                <input type="text" id="name" v-model="newItemName" required class="input-field" placeholder="Yaourt, Lait, Fromage...">
                            </div>
                            <div>
                                <label for="expiry" class="block text-sm font-medium text-gray-700 mb-1">Date d'expiration</label>
                                <input type="date" id="expiry" v-model="newItemExpiry" required class="input-field">
                            </div>

                            <button type="submit" :disabled="itemLoading || !newItemName || !newItemExpiry" class="btn-primary w-full py-3 text-white font-semibold rounded-lg bg-primary hover:bg-emerald-700 flex items-center justify-center">
                                <span v-if="itemLoading">Ajout...</span>
                                <span v-else>Ajouter au Frigo</span>
                            </button>
                        </form>
                        
                        <div v-if="expiredCount > 0" class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm font-medium">
                            Attention: {{ expiredCount }} article(s) sont expirés.
                        </div>
                    </div>
                </div>

                <!-- Colonne 2 & 3: Liste des articles -->
                <div class="lg:col-span-2">
                    <h2 class="text-2xl font-bold text-secondary mb-4">
                        Articles dans votre Frigo (par date d'expiration)
                    </h2>
                    
                    <div v-if="store.items.length === 0" class="p-10 text-center text-gray-500 bg-white rounded-xl card">
                        Votre frigo est vide. Ajoutez un premier article pour commencer!
                    </div>

                    <div v-else class="space-y-4 custom-scrollbar max-h-[80vh] overflow-y-auto">
                        <ItemCard 
                            v-for="item in itemsToDisplay" 
                            :key="item.id" 
                            :item="item" 
                            :getExpiryStatus="getExpiryStatus"
                            :deleteItem="deleteItem"
                            :itemLoading="itemLoading"
                        />
                    </div>
                </div>
            </div>
        </div>
        `
    };
    
    // Composant enfant pour un article
    const ItemCard = {
        props: ['item', 'getExpiryStatus', 'deleteItem', 'itemLoading'],
        setup(props) {
            const status = computed(() => props.getExpiryStatus(props.item.expiryDate));
            
            const formatDate = (dateString) => {
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                // Ensure correct date object is created if dateString is just 'YYYY-MM-DD'
                return new Date(dateString + 'T00:00:00').toLocaleDateString('fr-FR', options);
            };

            return { status, formatDate };
        },
        template: `
            <div class="p-4 bg-white rounded-lg flex items-center justify-between card border-l-8"
                 :class="{ 
                    'border-red-500': status.days < 0, 
                    'border-amber-400': status.days >= 0 && status.days <= 3, 
                    'border-primary': status.days > 3
                 }">
                
                <div class="flex-1 min-w-0">
                    <p class="text-lg font-semibold text-gray-800 truncate">{{ item.name }}</p>
                    <p class="text-sm text-gray-500">Exp. : {{ formatDate(item.expiryDate) }}</p>
                </div>
                
                <div class="flex items-center space-x-3 ml-4">
                    <!-- Pastille de statut -->
                    <span :class="status.color" class="text-white text-xs font-bold px-3 py-1 rounded-full shadow-md min-w-[70px] text-center">
                        {{ status.text }}
                    </span>
                    
                    <!-- Bouton Supprimer -->
                    <button @click="deleteItem(item.id)" 
                            :disabled="itemLoading"
                            class="text-gray-400 hover:text-red-500 p-2 rounded-full transition duration-150"
                            title="Supprimer l'article">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            </div>
        `
    };


    // --- 5. Application Principale Vue ---
    const App = {
        setup() {
            // Initialisation de l'état d'authentification de Firebase
            onMounted(() => {
                if (window.auth) {
                    window.auth.onAuthStateChanged(user => {
                        store.user = user;
                        store.isAuthReady = true;
                        if (user) {
                            // User is signed in, move to the fridge view
                            store.currentPage = 'fridge';
                        } else {
                            // User is signed out, move to the login view
                            store.currentPage = 'login';
                        }
                    });
                } else {
                    // Mock auth state if Firebase is not configured
                    store.isAuthReady = true;
                    store.currentPage = 'login';
                }
            });

            const currentView = computed(() => {
                if (!store.isAuthReady) {
                    return { template: '<div class="flex items-center justify-center min-h-screen text-xl text-secondary">Chargement de l\'authentification...</div>' };
                }
                switch (store.currentPage) {
                    case 'login':
                    case 'register':
                        return AuthScreen;
                    case 'fridge':
                        return FridgeScreen;
                    default:
                        return AuthScreen;
                }
            });

            return {
                currentView,
                store
            };
        },
        template: `
            <div class="relative">
                <component :is="currentView" />
            </div>
        `
    };

    // --- Montage de l'application ---
    // Vérification pour s'assurer que l'élément #app existe avant de monter l'application
    const appElement = document.getElementById('app');
    if (appElement) {
        createApp(App).mount('#app');
        console.log("FrigoBuddy Vue App Mounted Successfully.");
    } else {
        console.error("ERREUR: Impossible de trouver l'élément #app. L'application Vue ne peut pas se monter.");
    }

</script>
</body>
</html>
