version: "3.9"

services:
  keycloak_postgres:
    image: postgres:16
    container_name: keycloak_postgres
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: test1234
    networks:
      - grocerymate_devnet
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: keycloak
    command: ["start"]
    environment:
      # DATABASE
      KC_DB: postgres
      KC_DB_URL_HOST: keycloak_postgres
      KC_DB_URL_DATABASE: keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: test1234

      # ADMIN
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: test1234

      # HOSTNAME
      KC_HOSTNAME: id.gro-mate.tech
      KC_PROXY_HEADERS: xforwarded
      KC_HTTP_ENABLED: "true"

      # LIMITER LA RAM POUR Ã‰VITER "Killed"
      JAVA_OPTS: "-XX:MaxRAMPercentage=40"

    networks:
      - grocerymate_devnet
    depends_on:
      - keycloak_postgres

    ports:
      - "8089:8080"

    deploy:
      resources:
        limits:
          memory: 1500m

    restart: unless-stopped

volumes:
  postgres_data:

networks:
  grocerymate_devnet:
    external: true
    name: grocery-mate_devnet
